!function(e){"use strict";var r,n;if("undefined"==typeof r&&("undefined"!=typeof require?r=require("lodash"):e._&&(r=e._)),"undefined"==typeof Promise)if(Promise)n=Promise;else if(e.Promise)n=e.Promise;else{if("undefined"==typeof require)throw"Promise is not supported! Use latest version node/browser or promise-polyfill";n=require("promise-polyfill")}"undefined"==typeof Promise;var t=function(){function e(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}function t(n,t){var o=r.clone(n);return t&&(r.isObject(t)&&t.hasOwnProperty("message")?o.data=t.message:r.isString(t)&&(o.data=t),t instanceof e&&(o={message:t.message,code:t.code},t.hasOwnProperty("data")&&(o.data=t.data))),o}function o(e){return!!e&&"function"==typeof e.then}function s(e){return!!e.error}function i(e){return!!e.method}function a(e){return e.hasOwnProperty("result")&&e.hasOwnProperty("id")}function d(e){var t=[];return r.isArray(e)?r.each(e,function(e){t.push(u(e))}):r.isObject(e)&&t.push(u(e)),n.all(t).then(function(e){var n=[];return r.each(e,function(e){r.isUndefined(e)||n.push(e)}),1===n.length?y.toStream(JSON.stringify(n[0])):n.length>1&&y.toStream(JSON.stringify(n)),e})}function u(e){try{return s(e)?c(e):a(e)?f(e):i(e)?m(e):n.resolve({id:null,jsonrpc:"2.0",error:t(h.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),n.reject(e)}}function c(e){g.hasOwnProperty(e.id)?g[e.id].reject(e.error):console.log("Unknown request",e)}function f(e){g.hasOwnProperty(e.id)?(g[e.id].resolve(e.result),delete g[e.id]):console.log("unknown request",e)}function m(e){if(!v.hasOwnProperty(e.method))return n.resolve({jsonrpc:"2.0",id:e.id,error:t(h.METHOD_NOT_FOUND,{message:e.method})});try{var s;if(e.hasOwnProperty("params")){if(r.isArray(e.params))s=v[e.method].fn.apply(v,e.params);else if(r.isObject(e.params)){if(!(v[e.method].params instanceof Array))return n.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INVALID_PARAMS,"Undeclared arguments of the method "+e.method)});var i=[];if(v[e.method].params.forEach(function(r){e.params.hasOwnProperty(r)?(i.push(e.params[r]),delete e.params[r]):i.push(void 0)}),Object.keys(e.params).length>0)return n.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INVALID_PARAMS,{message:"Params: "+Object.keys(e.params).toString()+" not used"})});s=v[e.method].fn.apply(v,i)}}else s=v[e.method].fn();return e.hasOwnProperty("id")?o(s)?s.then(function(n){return r.isUndefined(n)&&(n=!0),{jsonrpc:"2.0",id:e.id,result:n}}).catch(function(r){return{jsonrpc:"2.0",id:e.id,error:t(h.INTERNAL_ERROR,r)}}):(r.isUndefined(s)&&(s=!0),n.resolve({jsonrpc:"2.0",id:e.id,result:s})):n.resolve()}catch(r){return n.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INTERNAL_ERROR,r)})}}function p(e,n){var t={jsonrpc:"2.0",method:e,params:n};return r.isObject(n)&&!r.isEmpty(n)&&(t.params=n),t}function l(e,t){O+=1;var o={jsonrpc:"2.0",method:e,id:O};return r.isObject(t)&&!r.isEmpty(t)&&(o.params=t),{promise:new n(function(e,r){g[O.toString()]={resolve:e,reject:r}}),message:o}}var h={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};e.prototype=new Error;var y=this,g={},O=0,v={};y.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},y.dispatch=function(e,n,t){if(r.isString(e)&&r.isArray(n)&&r.isFunction(t))v[e]={fn:t,params:n};else{if(!(r.isString(e)&&r.isFunction(n)&&r.isUndefined(t)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");v[e]={fn:n,params:null}}},y.call=function(e,r){var n=l(e,r);return y.toStream(JSON.stringify(n.message)),n.promise},y.notification=function(e,r){y.toStream(JSON.stringify(p(e,r)))},y.batch=function(e){var t=[],o=[];return r.each(e,function(e){if(e.hasOwnProperty("call")){var r=l(e.call.method,e.call.params);o.push(r.message),t.push(r.promise.then(function(e){return e},function(e){return e}))}else e.hasOwnProperty("notification")&&o.push(p(e.notification.method,e.notification.params))}),y.toStream(JSON.stringify(o)),n.all(t)},y.messageHandler=function(e){try{var r=JSON.parse(e);return d(r)}catch(e){return console.log("Error in messageHandler(): ",e),y.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:h.PARSE_ERROR})),n.reject(e)}},y.customException=function(r,n,t){return new e(r,n,t)}};if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return t});else if("undefined"!=typeof module&&"undefined"!=typeof module.exports)module.exports=t;else{if("undefined"==typeof e)return t;e.simple_jsonrpc=t}}(this);