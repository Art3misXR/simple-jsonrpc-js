(e=>{var f=Promise;if(void 0===(f=void 0===f?e.Promise:f))throw"Promise is not supported! Use latest version node/browser or promise-polyfill";function p(e){return void 0===e}function n(e){return"function"==typeof e}function l(e){return"string"==typeof e}function m(e){if(g(e)){for(var r in e)if(e.hasOwnProperty(r))return;return 1}return y(e)?!e.length:!e}function h(e,r){if(y(e))return e.map(r);for(var t in e)e.hasOwnProperty(t)&&r(e[t])}var y=Array.isArray,g=function(e){var r=typeof e;return null!=e&&("object"==r||"function"==r)},v={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};function O(e,r,t){this.message=r||"",this.code=e||-32e3,Boolean(t)&&(this.data=t)}function r(){var i=this,u={},t=0,c={};function d(e,r){e=JSON.parse(JSON.stringify(e));return r&&(g(r)&&r.hasOwnProperty("message")?e.data=r.message:l(r)&&(e.data=r),r instanceof O)&&(e={message:r.message,code:r.code},r.hasOwnProperty("data"))&&(e.data=r.data),e}function o(e){try{if(e.error)a=e,u.hasOwnProperty(a.id)?u[a.id].reject(a.error):console.log("Unknown request",a);else if((s=e).hasOwnProperty("result")&&s.hasOwnProperty("id"))o=e,u.hasOwnProperty(o.id)?(u[o.id].resolve(o.result),delete u[o.id]):console.log("unknown request",o);else{if(!e.method)return f.resolve({id:null,jsonrpc:"2.0",error:d(v.INVALID_REQUEST)});var r,t=e;if(!c.hasOwnProperty(t.method))return f.resolve({jsonrpc:"2.0",id:t.id,error:d(v.METHOD_NOT_FOUND,{message:t.method})});try{if(t.hasOwnProperty("params")){if("pass"==c[t.method].params)r=c[t.method].fn.call(c,t.params);else if(y(t.params))r=c[t.method].fn.apply(c,t.params);else if(g(t.params)){if(!(c[t.method].params instanceof Array))return f.resolve({jsonrpc:"2.0",id:t.id,error:d(v.INVALID_PARAMS,"Undeclared arguments of the method "+t.method)});var n=[];if(c[t.method].params.forEach(function(e){t.params.hasOwnProperty(e)?(n.push(t.params[e]),delete t.params[e]):n.push(void 0)}),0<Object.keys(t.params).length)return f.resolve({jsonrpc:"2.0",id:t.id,error:d(v.INVALID_PARAMS,{message:"Params: "+Object.keys(t.params).toString()+" not used"})});r=c[t.method].fn.apply(c,n)}}else r=c[t.method].fn();return t.hasOwnProperty("id")?(e=>e&&"function"==typeof e.then)(r)?r.then(function(e){return p(e)&&(e=i.undefinedResult),{jsonrpc:"2.0",id:t.id,result:e}}).catch(function(e){return{jsonrpc:"2.0",id:t.id,error:d(v.INTERNAL_ERROR,e)}}):(p(r)&&(r=i.undefinedResult),f.resolve({jsonrpc:"2.0",id:t.id,result:r})):f.resolve()}catch(e){return f.resolve({jsonrpc:"2.0",id:t.id,error:d(v.INTERNAL_ERROR,e)})}}}catch(e){return console.error("Resolver error:"+e.message,e),f.reject(e)}var o,s,a}function s(e,r){e={jsonrpc:"2.0",method:e,params:r};return g(r)&&!m(r)&&(e.params=r),e}function a(e,r){e={jsonrpc:"2.0",method:e,id:t+=1};return g(r)&&!m(r)&&(e.params=r),{promise:new f(function(e,r){u[t.toString()]={resolve:e,reject:r}}),message:e}}i.undefinedResult=!0,i.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},i.dispatch=function(e,r,t){if(l(e)&&"pass"==r&&n(t))c[e]={fn:t,params:r};else if(l(e)&&y(r)&&n(t))c[e]={fn:t,params:r};else{if(!(l(e)&&n(r)&&p(t)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");c[e]={fn:r,params:null}}},i.on=i.dispatch,i.off=function(e){delete c[e]},i.call=function(e,r){e=a(e,r);return i.toStream(JSON.stringify(e.message)),e.promise},i.notification=function(e,r){i.toStream(JSON.stringify(s(e,r)))},i.batch=function(e){var t=[],n=[];return h(e,function(e){var r;e.hasOwnProperty("call")?(r=a(e.call.method,e.call.params),n.push(r.message),t.push(r.promise.then(function(e){return e},function(e){return e}))):e.hasOwnProperty("notification")&&n.push(s(e.notification.method,e.notification.params))}),i.toStream(JSON.stringify(n)),f.all(t)},i.messageHandler=function(e){try{var r=JSON.parse(e);return n=[],y(t=r)?h(t,function(e){n.push(o(e))}):g(t)&&n.push(o(t)),f.all(n).then(function(e){var r=[];return h(e,function(e){p(e)||r.push(e)}),1===r.length?i.toStream(JSON.stringify(r[0])):1<r.length&&i.toStream(JSON.stringify(r)),e})}catch(e){return console.log("Error in messageHandler(): ",e),i.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:v.PARSE_ERROR})),f.reject(e)}var t,n},i.customException=function(e,r,t){return new O(e,r,t)}}O.prototype=new Error,r.connect_xhr=function(t,n){null==t&&(t="/"),"content-type"in(n=null==n?{}:n)||(n["content-type"]="application/json; charset=utf-8"),"method"in n||(n.method="POST"),"onerror"in n||(n.onerror=console.error);var o=new r;return o.toStream=function(e){var r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==this.readyState)try{JSON.parse(this.responseText),o.messageHandler(this.responseText)}catch(e){n.onerror(e)}},r.open(n.method,t,!0),r.setRequestHeader("Content-type",n["content-type"]),"authorization"in n&&r.setRequestHeader("Authorization",n.authorization),r.send(e)},o},"function"==typeof define&&define.amd?define("simple_jsonrpc",[],function(){return r}):"undefined"!=typeof module&&void 0!==module.exports?module.exports=r:void 0!==e&&(e.simple_jsonrpc=r)})(this);
