!function(e,r){"use strict";var n;"undefined"==typeof n&&("undefined"!=typeof require?n=require("lodash"):e._&&(n=e._));var t=function(){function e(e,r,n){this.message=r||"",this.code=e||-32e3,Boolean(n)&&(this.data=n)}function t(r,t){var o=n.clone(r);return t&&(n.isObject(t)&&t.hasOwnProperty("message")?o.data=t.message:n.isString(t)&&(o.data=t),t instanceof e&&(o={message:t.message,code:t.code},t.hasOwnProperty("data")&&(o.data=t.data))),o}function o(e){return!!e&&"function"==typeof e.then}function s(e){return!!e.error}function i(e){return!!e.method}function a(e){return e.hasOwnProperty("result")&&e.hasOwnProperty("id")}function c(e){var t=[];return n.isArray(e)?n.each(e,function(e){t.push(u(e))}):n.isObject(e)&&t.push(u(e)),r.all(t).then(function(e){var r=[];return n.each(e,function(e){n.isUndefined(e)||r.push(e)}),1===r.length?g.toStream(JSON.stringify(r[0])):r.length>1&&g.toStream(JSON.stringify(r)),e})}function u(e){try{return s(e)?d(e):a(e)?f(e):i(e)?m(e):r.resolve({id:null,jsonrpc:"2.0",error:t(h.INVALID_REQUEST)})}catch(e){return console.error("Resolver error:"+e.message,e),r.reject(e)}}function d(e){y.hasOwnProperty(e.id)?y[e.id].reject(e.error):console.log("Unknown request",e)}function f(e){y.hasOwnProperty(e.id)?(y[e.id].resolve(e.result),delete y[e.id]):console.log("unknown request",e)}function m(e){if(!v.hasOwnProperty(e.method))return r.resolve({jsonrpc:"2.0",id:e.id,error:t(h.METHOD_NOT_FOUND,{message:e.method})});try{var s;if(e.hasOwnProperty("params")){if(n.isArray(e.params))s=v[e.method].fn.apply(v,e.params);else if(n.isObject(e.params)){if(!(v[e.method].params instanceof Array))return r.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INVALID_PARAMS,"Undeclared arguments of the method "+e.method)});var i=[];if(v[e.method].params.forEach(function(r){e.params.hasOwnProperty(r)?(i.push(e.params[r]),delete e.params[r]):i.push(void 0)}),Object.keys(e.params).length>0)return r.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INVALID_PARAMS,{message:"Params: "+Object.keys(e.params).toString()+" not used"})});s=v[e.method].fn.apply(v,i)}}else s=v[e.method].fn();return e.hasOwnProperty("id")?o(s)?s.then(function(r){return n.isUndefined(r)&&(r=!0),{jsonrpc:"2.0",id:e.id,result:r}}).catch(function(r){return{jsonrpc:"2.0",id:e.id,error:t(h.INTERNAL_ERROR,r)}}):(n.isUndefined(s)&&(s=!0),r.resolve({jsonrpc:"2.0",id:e.id,result:s})):r.resolve()}catch(n){return r.resolve({jsonrpc:"2.0",id:e.id,error:t(h.INTERNAL_ERROR,n)})}}function l(e,r){var t={jsonrpc:"2.0",method:e,params:r};return n.isObject(r)&&!n.isEmpty(r)&&(t.params=r),t}function p(e,t){O+=1;var o={jsonrpc:"2.0",method:e,id:O};return n.isObject(t)&&!n.isEmpty(t)&&(o.params=t),{promise:new r(function(e,r){y[O.toString()]={resolve:e,reject:r}}),message:o}}var h={PARSE_ERROR:{code:-32700,message:"Invalid JSON was received by the server. An error occurred on the server while parsing the JSON text."},INVALID_REQUEST:{code:-32600,message:"Invalid Request. The JSON sent is not a valid Request object."},METHOD_NOT_FOUND:{code:-32601,message:"Method not found. The method does not exist / is not available."},INVALID_PARAMS:{code:-32602,message:"Invalid params. Invalid method parameter(s)."},INTERNAL_ERROR:{code:-32603,message:"Internal error. Internal JSON-RPC error."}};e.prototype=new Error;var g=this,y={},O=0,v={};g.toStream=function(e){console.log("Need define the toStream method before use"),console.log(arguments)},g.dispatch=function(e,r,t){if(n.isString(e)&&n.isArray(r)&&n.isFunction(t))v[e]={fn:t,params:r};else{if(!(n.isString(e)&&n.isFunction(r)&&n.isUndefined(t)))throw new Error("Missing required argument: functionName - string, paramsNameFn - string or function");v[e]={fn:r,params:null}}},g.call=function(e,r){var n=p(e,r);return g.toStream(JSON.stringify(n.message)),n.promise},g.notification=function(e,r){g.toStream(JSON.stringify(l(e,r)))},g.batch=function(e){var t=[],o=[];return n.each(e,function(e){if(e.hasOwnProperty("call")){var r=p(e.call.method,e.call.params);o.push(r.message),t.push(r.promise.then(function(e){return e},function(e){return e}))}else e.hasOwnProperty("notification")&&o.push(l(e.notification.method,e.notification.params))}),g.toStream(JSON.stringify(o)),r.all(t)},g.messageHandler=function(e){try{var n=JSON.parse(e);return c(n)}catch(e){return console.log("Error in messageHandler(): ",e),g.toStream(JSON.stringify({id:null,jsonrpc:"2.0",error:h.PARSE_ERROR})),r.reject(e)}},g.customException=function(r,n,t){return new e(r,n,t)}};if("function"==typeof define&&define.amd)define("simple_jsonrpc",[],function(){return t});else if("undefined"!=typeof module&&"undefined"!=typeof module.exports)module.exports=t;else{if("undefined"==typeof e)return t;e.simple_jsonrpc=t}}(this,this.Promise||global.Promise||require("promise-polyfill"));